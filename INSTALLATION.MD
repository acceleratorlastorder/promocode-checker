# Installation

Ce document explique comment installer et lancer l‚ÄôAPI **Promocode Service** en local ou via Docker / Docker Compose.

---

## üîß Pr√©requis

- **Node.js** ‚â• 22.x
- **npm** (install√© avec Node.js)
- **PostgreSQL** (instance locale, distante ou via docker)
- **Docker & Docker Compose** _(optionnel pour containerisation)_

---

## üè° Installation locale

1. **Cloner le d√©p√¥t**

    ```bash
    git clone <repository-url>
    cd <repository-directory>
    ```

2. **Copier & configurer les variables d‚Äôenvironnement**

    ```bash
    cp .env.example .env
    ```

    Puis √©ditez `.env` et renseignez vos param√®tres :

    ```dotenv
        # Development Environment Configuration Template
        # Copy this file to .env.development and fill in the actual values

        # Server Configuration
        NODE_ENV=development
        PORT=3000
        HOST=0.0.0.0
        LOG_LEVEL=info

        # Security - REQUIRED
        # Generate a strong API key (minimum 16 characters, recommended 32+)
        # Example: openssl rand -hex 32
        API_KEY=6fdb0b593edeba06ed02175246a6042966bde13330d800bc1d994530fbdbe89d

        # Database Configuration (PostgreSQL)
        DATABASE_HOST=postgres
        DATABASE_PORT=5432
        DATABASE_USER=promocode_user
        DATABASE_PASSWORD=promocode_password
        DATABASE_NAME=promocode_db

        # Either provide DATABASE_URL or individual components
        DATABASE_URL=postgresql://${DATABASE_USER}:${DATABASE_PASSWORD}@${DATABASE_HOST}:${DATABASE_PORT}/${DATABASE_NAME}

        # External APIs (OpenWeatherMap)
        OPENWEATHERMAP_API_KEY=your-openweather-api-key-here
        OPENWEATHERMAP_API_URL=https://api.openweathermap.org/data/2.5

        # CORS Configuration (optional)
        ALLOWED_ORIGINS=http://localhost:3000,http://127.0.0.1:3000

        # Weather Service Configuration
        # Set to 'false' for production to use real OpenWeatherMap API
        USE_MOCK_WEATHER=true
    ```

3. **Installer les d√©pendances**

    ```bash
    npm install
    ```

4. **Initialiser la base (Prisma)**

    - Appliquer les migrations :

        ```bash
        npx prisma migrate dev --name init
        ```

    - G√©n√©rer le client Prisma :

        ```bash
        npx prisma generate
        ```

5. **Transpilation de l‚Äôapplication (TypeScript ‚Üí JavaScript)**

    ```bash
    npm run build
    ```

6. **D√©marrer l‚ÄôAPI**

    ```bash
    npm start
    ```

    > Le serveur √©coute par d√©faut sur `http://localhost:3000`.
    > Pour la doc Swagger : `http://localhost:3000/documentation`

7. **Mode d√©veloppement**
   Pour relancer automatiquement √† chaque changement de code :

    ```bash
    npm run dev
    ```

8. **Tests unitaires (Jest)**
   Pour lancer la suite de tests :
    ```bash
    npm test
    ```

---

## üê≥ Lancer avec Docker / Docker Compose

Deux fichiers `docker-compose.yml` et `docker-compose.db.yml` sont fournis :

- **`docker-compose.db.yml`** : d√©marre la base PostgreSQL
- **`docker-compose.yml`** : d√©marre uniquement l‚ÄôAPI (utile si vous avez d√©j√† PostgreSQL)

### 1. Cr√©er `.env` pour Docker

Copiez les m√™mes variables `.env` que pour l‚Äôinstallation locale. Docker Compose les injectera automatiquement.

### 2. D√©marrage (Si vous n'avez pas d√©j√† de base de donn√©es PostgreSQL existante)

```bash
docker-compose -f docker-compose.db.yml --env-file ./.env up -d
```

Cela lancera :

- **postgres** (port 5432)
- **migrate** (prisma migration)
- **adminer** (port 8080)

Une fois les services up, vous pouvez en suite utiliser la commande de l'√©tape 3

### 3. D√©marrage en mode ¬´ standalone ¬ª (si PostgreSQL existe d√©j√† ou apr√®s avoir lancer)

```bash
docker-compose --env-file ./.env up -d
```

Cela lancera :

- **app** (port 3000)

---

## ‚úÖ V√©rification

- **Ping sant√©**

    ```bash
    curl http://localhost:3000/ping
    ```

    ‚Üí doit renvoyer `{ "status": "ok", "timestamp": "‚Ä¶" }`

- **Swagger / OpenAPI**
  Ouvrez :

    ```
    http://localhost:3000/documentation
    ```

- **Endpoints Promocode**

    - `POST /api/promocodes`
    - `POST /api/promocodes/validate`
    - etc.

---

## üìò Ressources

- **Doc Prisma** : [https://www.prisma.io/docs](https://www.prisma.io/docs)
- **Swagger UI** int√©gr√© : `/documentation`
- **README.md** pour plus de d√©tails sur l‚Äôarchitecture

---
